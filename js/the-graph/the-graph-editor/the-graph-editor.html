<link rel="import" href="../the-graph/the-graph.html">
<link rel="import" href="../../property-editor/fmx-task-editor.html">
<link rel="import" href="../../property-editor/fmx-flow-editor.html">
<link rel="import" href="../../property-editor/fmx-inport-editor.html">
<link rel="import" href="../../property-editor/fmx-outport-editor.html">

<polymer-element name="the-graph-editor" attributes="grid snap width height autolayout theme selectedNodes selectedEdges animatedEdges onContextMenu" touch-action="none">
    <template>
        <the-graph id="graph"
                   name="{{ graph.properties.name }}"
                   graph="{{nofloGraph}}"
                   menus="{{menus}}"
                   width="{{width}}" height="{{height}}"
                   pan="{{pan}}" scale="{{scale}}"
                   autolayout="{{autolayout}}"
                   theme="{{theme}}"
                   selectedNodes="{{selectedNodes}}"
                   selectedEdges="{{selectedEdges}}"
                   animatedEdges="{{animatedEdges}}"
                   getMenuDef="{{getMenuDef}}"></the-graph>
    </template>
    <script>
        (function() {
            "use strict";
            Polymer('the-graph-editor', {
                graph: null,
                grid: 72,
                snap: 36,
                width: 800,
                height: 600,
                scale: 1,
                plugins: {},
                nofloGraph: null,
                menus: null,
                autolayout: false,
                theme: "light",
                selectedNodes: [],
                selectedEdges: [],
                animatedEdges: [],
                created: function() {
                    // Default pan
                    this.pan = [0, 0];
                    // Default context menu defs
                    this.menus = {
                        app: {
                            n4: {// add node
                                icon: "plus-circle",
                                iconLabel: "Add",
                                action: function(graph, itemKey, item) {
                                    var maxIdx = 0;
                                    var keys = fmx.doc.tasks.keys();
                                    for (var i = 0; i < keys.length; i++) {
                                        var idx = parseInt(keys[i]);
                                        if (idx > maxIdx) {
                                            maxIdx = idx;
                                        }
                                    }
                                    maxIdx++;
                                    var id = maxIdx;
                                    var component = {
                                        inports: [{name: 'EventData', type: 'all'}],
                                        outports: []
                                    };
                                    var metadata = {
                                        label: 'Task_' + id,
                                        description: 'Description of Task_' + id,
                                        x: item.x - 70,
                                        y: item.y - 100,
                                        inports: [{access: 'readonly',
                                                type: {
                                                    label: '',
                                                    fileId: ''
                                                }}]
                                    };
                                    //var newNode = document.getElementById("editor").nofloGraph.addNode(id, component, metadata);
                                    console.log(id);
                                    fmx.doc.tasks.set(id.toString(), {
                                        id: id,
                                        component: component,
                                        metadata: metadata
                                    });
                                }
                            },
                            s4: {
                                icon: "truck",
                                iconLabel: "Export",
                                action: function(graph, itemKey, item) {
                                    console.log("export this FMX document");
                                    var dialog = document.getElementById('exportXMLdialog');
                                    dialog.querySelector('pre').textContent = fmx.generateXML();
                                    dialog.toggle();
                                }
                            }
                        },
                        edge: {
                            n4: {
                                icon: "pencil-square-o",
                                iconLabel: "Edit",
                                action: function(graph, itemKey, item) {
                                    //graph.removeEdge(item.from.node, item.from.port, item.to.node, item.to.port);
                                    var dialog = document.createElement('fmx-flow-editor');
                                    dialog.graph = graph;
                                    dialog.edge = item;
                                    document.body.appendChild(dialog);
                                }
                            },
                            s4: {
                                icon: "trash-o",
                                iconLabel: "Delete",
                                action: function(graph, itemKey, item) {
                                    //graph.removeEdge(item.from.node, item.from.port, item.to.node, item.to.port);

                                    var getEdgeId = function(edge) {
                                        return (edge.from.node + '_' + edge.from.port + '_' + edge.to.node + '_' + edge.to.port).toLowerCase();
                                    };
                                    var edgeId = getEdgeId(item);
                                    console.log("delete edge: " + edgeId);
                                    fmx.doc.flows.delete(edgeId);
                                }
                            }
                        },
                        node: {
                            n4: {
                                icon: "pencil-square-o",
                                iconLabel: "Edit",
                                action: function(graph, itemKey, item) {
                                    var dialog = document.createElement('fmx-task-editor');
                                    console.log(graph);
                                    dialog.graph = graph;
                                    dialog.node = item;
                                    document.body.appendChild(dialog);
                                }
                            },
//                            w4: {
//                                icon: "sign-in",
//                                iconLabel: "Add",
//                                action: function(graph, itemKey, item) {
//                                    var dialog = document.createElement('fmx-inport-editor');
//                                    dialog.action = 'Add';
//                                    dialog.graph = graph;
//                                    dialog.port = item;
//                                    document.body.appendChild(dialog);
//                                }
//                            },
                            e4: {
                                icon: "sign-out",
                                iconLabel: "Add",
                                action: function(graph, itemKey, item) {
                                    graph.addNodeOutport(itemKey, 'Output', 'all');
                                    fmx.doc.tasks.set(itemKey, item);
                                }
                            },
                            s4: {// delete node
                                icon: "trash-o",
                                iconLabel: "Delete",
                                action: function(graph, itemKey, item) {
                                    console.log("itemKey: " + itemKey);
                                    console.log(item);
                                    //graph.removeNode(itemKey);
                                    fmx.doc.tasks.delete(itemKey);
                                    console.log("node " + itemKey + " has been deleted")
                                }
                            }
                        },
                        nodeInport: {
                            n4: {
                                icon: "pencil-square-o",
                                iconLabel: "edit",
                                action: function(graph, itemKey, item) {
                                    //graph.removeEdge(item.from.node, item.from.port, item.to.node, item.to.port);
                                    console.log(graph);
                                    var dialog = document.createElement('fmx-inport-editor');
                                    dialog.action = 'Edit';
                                    dialog.graph = graph;
                                    dialog.port = item;
                                    document.body.appendChild(dialog);
                                }
                            },
                            s4: {
                                icon: "trash-o",
                                iconLabel: "delete",
                                action: function(graph, itemKey, item) {
                                    //graph.removeNode(itemKey);
                                }
                            }
                        },
                        nodeOutport: {
                            n4: {
                                icon: "pencil-square-o",
                                iconLabel: "edit",
                                action: function(graph, itemKey, item) {
                                    //graph.removeEdge(item.from.node, item.from.port, item.to.node, item.to.port);
                                    var dialog = document.createElement('fmx-outport-editor');
                                    dialog.action = 'Edit';
                                    dialog.graph = graph;
                                    dialog.port = item;
                                    document.body.appendChild(dialog);
                                }
                            },
                            s4: {
                                icon: "trash-o",
                                iconLabel: "delete",
                                action: function(graph, itemKey, item) {
                                    graph.removeNode(itemKey);
                                }
                            }
                        },
                        graphInport: {
                            icon: "sign-in",
                            iconColor: 2,
                            n4: {
                                label: "inport"
                            },
                            s4: {
                                icon: "trash-o",
                                iconLabel: "delete",
                                action: function(graph, itemKey, item) {
                                    graph.removeInport(itemKey);
                                }
                            }
                        },
                        graphOutport: {
                            icon: "sign-out",
                            iconColor: 5,
                            n4: {
                                label: "outport"
                            },
                            s4: {
                                icon: "trash-o",
                                iconLabel: "delete",
                                action: function(graph, itemKey, item) {
                                    graph.removeOutport(itemKey);
                                }
                            }
                        },
                        group: {
                            icon: "th",
                            s4: {
                                icon: "trash-o",
                                iconLabel: "ungroup",
                                action: function(graph, itemKey, item) {
                                    graph.removeGroup(itemKey);
                                }
                            }
                        },
                        selection: {
                            icon: "th"
                        }
                    };
                },
                selectedNodesChanged: function() {
                    console.log("selectedNodesChanged");
                },
                selectedEdgesChanged: function() {
                    console.log("selectedEdgesChanged");
                },
                ready: function() {
                },
                attached: function() {
                },
                detached: function() {
                    for (var name in this.plugins) {
                        this.plugins[name].unregister(this);
                        delete this.plugins[name];
                    }
                },
                addPlugin: function(name, plugin) {
                    this.plugins[name] = plugin;
                    plugin.register(this);
                },
                addMenu: function(type, options) {
                    // options: icon, label
                    this.menus[type] = options;
                },
                addMenuCallback: function(type, callback) {
                    if (!this.menus[type]) {
                        return;
                    }
                    this.menus[type].callback = callback;
                },
                addMenuAction: function(type, direction, options) {
                    if (!this.menus[type]) {
                        this.menus[type] = {};
                    }
                    var menu = this.menus[type];
                    menu[direction] = options;
                },
                getMenuDef: function(options) {
                    // Options: type, graph, itemKey, item
                    if (options.type && this.menus[options.type]) {
                        var defaultMenu = this.menus[options.type];
                        if (defaultMenu.callback) {
                            return defaultMenu.callback(defaultMenu, options);
                        }
                        return defaultMenu;
                    }
                    return null;
                },
                widthChanged: function() {
                    this.style.width = this.width + "px";
                },
                heightChanged: function() {
                    this.style.height = this.height + "px";
                },
                graphChanged: function() {
                    if (typeof this.graph.addNode === 'function') {
                        this.buildInitialLibrary(this.graph);
                        this.nofloGraph = this.graph;
                        return;
                    }
                    require('noflo').graph.loadJSON(this.graph, function(nofloGraph) {
                        this.buildInitialLibrary(nofloGraph);
                        this.nofloGraph = nofloGraph;
                    }.bind(this));
                },
                buildInitialLibrary: function(nofloGraph) {
                    /*if (Object.keys(this.$.graph.library).length !== 0) {
                     // We already have a library, skip
                     // TODO what about loading a new graph? Are we making a new editor?
                     return;
                     }*/

                    nofloGraph.nodes.forEach(function(node) {
                        var component = {
                            name: node.component,
                            icon: 'cog',
                            description: '',
                            inports: [],
                            outports: []
                        };
                        Object.keys(nofloGraph.inports).forEach(function(pub) {
                            var exported = nofloGraph.inports[pub];
                            if (exported.process === node.id) {
                                for (var i = 0; i < component.inports.length; i++) {
                                    if (component.inports[i].name === exported.port) {
                                        return;
                                    }
                                }
                                component.inports.push({
                                    name: exported.port,
                                    type: 'all'
                                });
                            }
                        });
                        Object.keys(nofloGraph.outports).forEach(function(pub) {
                            var exported = nofloGraph.outports[pub];
                            if (exported.process === node.id) {
                                for (var i = 0; i < component.outports.length; i++) {
                                    if (component.outports[i].name === exported.port) {
                                        return;
                                    }
                                }
                                component.outports.push({
                                    name: exported.port,
                                    type: 'all'
                                });
                            }
                        });
                        nofloGraph.initializers.forEach(function(iip) {
                            if (iip.to.node === node.id) {
                                for (var i = 0; i < component.inports.length; i++) {
                                    if (component.inports[i].name === iip.to.port) {
                                        return;
                                    }
                                }
                                component.inports.push({
                                    name: iip.to.port,
                                    type: 'all'
                                });
                            }
                        });
                        nofloGraph.edges.forEach(function(edge) {
                            var i;
                            if (edge.from.node === node.id) {
                                for (i = 0; i < component.outports.length; i++) {
                                    if (component.outports[i].name === edge.from.port) {
                                        return;
                                    }
                                }
                                component.outports.push({
                                    name: edge.from.port,
                                    type: 'all'
                                });
                            }
                            if (edge.to.node === node.id) {
                                for (i = 0; i < component.inports.length; i++) {
                                    if (component.inports[i].name === edge.to.port) {
                                        return;
                                    }
                                }
                                component.inports.push({
                                    name: edge.to.port,
                                    type: 'all'
                                });
                            }
                        });
                        this.registerComponent(component, true);
                    }.bind(this));
                },
                registerComponent: function(definition, generated) {
                    this.$.graph.registerComponent(definition, generated);
                },
                updateIcon: function(nodeId, icon) {
                    this.$.graph.updateIcon(nodeId, icon);
                },
                rerender: function() {
                    this.$.graph.rerender();
                },
                triggerAutolayout: function() {
                    this.$.graph.triggerAutolayout();
                },
                triggerFit: function() {
                    this.$.graph.triggerFit();
                },
                animateEdge: function(edge) {
                    // Make sure unique
                    var index = this.animatedEdges.indexOf(edge);
                    if (index === -1) {
                        this.animatedEdges.push(edge);
                    }
                },
                unanimateEdge: function(edge) {
                    var index = this.animatedEdges.indexOf(edge);
                    if (index >= 0) {
                        this.animatedEdges.splice(index, 1);
                    }
                },
                getComponent: function(name) {
                    return this.$.graph.getComponent(name);
                },
                getLibrary: function() {
                    return this.$.graph.library;
                },
                toJSON: function() {
                    return this.nofloGraph.toJSON();
                }
            });
        })();
    </script>
</polymer-element>
