<link rel="import" href="noflo-node-inspector.html">
<link rel="import" href="noflo-exported-inspector.html">
<link rel="import" href="noflo-group-inspector.html">
<link rel="import" href="../the-card/the-card/the-card.html">
<polymer-element name="property-editor" attributes="graphs component node edge">
	<template>
		<style>
			#context {
				position: fixed;
				-webkit-transform: translateZ(0);
				transform: translateZ(0);
				left: 10px;
				top: 140px;
				width: calc(72px * 4 + 16px);
				max-height: calc(100% - 140px);
				box-sizing: border-box;
				display: block;
				overflow-y: auto;
				overflow-x: visible;
				/*border-radius:5px;
				 border:1px #C8C7CC solid;*/
			}
		</style>
		<section id="context"></section>
		<the-panel id="fixed" edge="right" size="324" handle="36" automatic="false">
			<header></header>
			<main></main>
			<footer></footer>
		</the-panel>
	</template>
	<script>
		Polymer('property-editor', {
			editor : null,
			graphs : [],
			nodes : [],
			edges : [],
			component : '',
			ready : function() {
				//console.log("property-editor.html ready");
				//document.addEventListener('nodeLabelClicked', this.nodeLabelClicked);
				//document.addEventListener('nodeEntered', this.nodeEntered);
				//document.addEventListener('nodeLeft', this.nodeLeft);
				document.addEventListener('selectedNodesChanged', this.selectedNodeChanged.bind(this));
			},
			nodeEntered : function(evt) {
				console.log("nodeEntered");
			},
			nodeLeft : function(evt) {
				console.log("nodeLeft");
			},
			// nodeLabelClicked : function() {
			// console.log("property-editor.html nodeLabelClicked");
			//
			// if ( typeof this.nodes !== 'undefined') {
			// if (this.nodes.length) {
			// this.showNodeCards();
			// } else {
			// this.hideNodeCards();
			// }
			// }
			// },

			selectedNodeChanged : function(evt) {
				console.log("property-editor.html selectedNodeChanged");
				if ( typeof evt.detail !== 'undefined' && evt.detail.length > 0) {
					this.showNodeCards(evt.detail);
				} else {
					this.hideNodeCards(evt.detail);
				}
			},
			// nodesChanged : function() {
			// console.log("nodesChanged");
			//
			// if ( typeof this.nodes !== 'undefined') {
			// if (this.nodes.length) {
			// this.showNodeCards();
			// } else {
			// this.hideNodeCards();
			// }
			// }
			// },

			nodeInspectors : {},

			showPopup : function() {

			},

			showNodeCards : function(selectedNodes) {
				var editor = document.getElementById('editor');
				this.graphs = [editor.graph];

				selectedNodes.forEach( function(node) {
					var id = node.id;
					if (this.nodeInspectors[id]) {
						return;
					}
					var inspector = document.createElement('noflo-node-inspector');
					inspector.node = node;
					inspector.component = this.editor.getComponent(node.component);
					inspector.graph = this.graphs[this.graphs.length - 1];
					this.nodeInspectors[id] = document.createElement('the-card');
					this.nodeInspectors[id].type = 'node-inspector';
					this.nodeInspectors[id].appendChild(inspector);
					this.nodeInspectors[id].addTo(this.$.context);
				}.bind(this));

				var found;
				Object.keys(this.nodeInspectors).forEach( function(id) {
					found = false;
					selectedNodes.forEach(function(node) {
						if (node.id === id) {
							found = true;
						}
					});
					if (!found) {
						this.nodeInspectors[id].parentNode.removeChild(this.nodeInspectors[id]);
						delete this.nodeInspectors[id];
					}
				}.bind(this));
			},
			hideNodeCards : function() {
				for (var id in this.nodeInspectors) {
					this.nodeInspectors[id].parentNode.removeChild(this.nodeInspectors[id]);
					delete this.nodeInspectors[id];
				}
			},

			editorChanged : function() {
				console.log("editorChanged");
				if (!this.editor) {
					return;
				}
				this.editor.addMenuAction('graphInport', 'n4', {
					icon : 'pencil-square-o',
					iconLabel : 'rename',
					action : function(graph, itemKey, item) {
						var dialog = document.createElement('noflo-exported-inspector');
						dialog.graph = this.graphs[this.graphs.length - 1];
						dialog.publicport = itemKey;
						dialog.privateport = item;
						dialog.direction = 'input';
						document.body.appendChild(dialog);
					}.bind(this)
				});
				this.editor.addMenuAction('graphOutport', 'n4', {
					icon : 'pencil-square-o',
					iconLabel : 'rename',
					action : function(graph, itemKey, item) {
						var dialog = document.createElement('noflo-exported-inspector');
						dialog.graph = this.graphs[this.graphs.length - 1];
						dialog.publicport = itemKey;
						dialog.privateport = item;
						dialog.direction = 'output';
						document.body.appendChild(dialog);
					}.bind(this)
				});
				this.editor.addMenuAction('selection', 'w4', {
					icon : 'square-o',
					iconLabel : 'group',
					action : this.group.bind(this)
				});
				this.editor.addMenuCallback('node', function(defaultMenu, options) {
					if (!options.item.component) {
						return defaultMenu;
					}
					//if (!this.canGetSource(options.item.component)) {
					return defaultMenu;
					//}
					// var i, menuKey;
					// var localMenu = {};
					// var openAction = {
					// icon : 'arrow-circle-o-up',
					// iconLabel : 'open',
					// action : function(graph, itemKey, item) {
					// if ( typeof ga === 'function') {
					// ga('send', 'event', 'menu', 'click', 'openNode');
					// }
					// window.location.hash += '/' + encodeURIComponent(item.id);
					// }
					// };
					// for (menuKey in defaultMenu) {
					// localMenu[menuKey] = defaultMenu[menuKey];
					// }
					// localMenu.n4 = openAction;
					// return localMenu;
				}.bind(this));
			},

			group : function(graph, itemKey, item) {
				console.log("group itemKey:" + itemKey + " item: " + item);

				if ( typeof ga === 'function') {
					ga('send', 'event', 'menu', 'click', 'createGroup');
				}

				// See if the nodes are already part of a group
				var group = '';
				var description = '';
				var selectedNodes = item.nodes;
				selectedNodes.sort();

				graph.groups.forEach(function(grp) {
					var grpNodes = JSON.parse(JSON.stringify(grp.nodes));
					grpNodes.sort();
					if (grpNodes.join(',') == selectedNodes.join(',')) {
						group = grp.name;
						description = grp.metadata.description;
					}
				});

				var dialog = document.createElement('noflo-group-inspector');
				dialog.group = group;
				dialog.groupdescription = description;
				dialog.nodes = selectedNodes;
				dialog.graph = graph;
				document.body.appendChild(dialog);
			},

			getpanel : function() {
				this.fire('toolpanel', this.$.fixed);
				this.fire('contextpanel', this.$.context);
			},
		});
	</script>
</polymer-element>
